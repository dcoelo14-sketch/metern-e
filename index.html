<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>M√©t√©o locale ‚Äì Ern√©e</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #eef4f9;
        padding: 16px;
    }
    h1 { color: #003366; }

    .box {
        background: #fff;
        padding: 14px;
        margin-bottom: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .alert {
        padding: 14px;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: bold;
        color: white;
        margin-bottom: 10px;
    }

    .green { background: #2e7d32; }
    .orange { background: #f57c00; }
    .red { background: #c62828; }

    .forecast {
        font-weight: bold;
    }

    .update {
        font-size: 0.85em;
        color: #555;
        text-align: right;
    }

    /* Pr√©visions 2h */
    #forecast-2h {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .quarter {
        background: rgba(255,255,255,0.8);
        padding: 8px;
        border-radius: 8px;
        text-align: center;
        font-size: 14px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .wicon {
        width: 40px;
        height: 40px;
    }

    /* Barom√®tre */
    #barometer {
        width: 220px;
        height: 220px;
        border-radius: 50%;
        margin: auto;
        position: relative;
        background: radial-gradient(circle, #ffffff 60%, #dcdcdc);
        box-shadow: inset 0 0 12px rgba(0,0,0,0.4), 0 0 8px rgba(0,0,0,0.3);
        overflow: hidden;
    }

    #zones {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background:
            conic-gradient(
                #c62828 0deg 60deg,
                #f57c00 60deg 120deg,
                #2e7d32 120deg 180deg
            );
        transform: rotate(-100deg);
        opacity: 0.35;
    }

    #ticks { position: absolute; width: 100%; height: 100%; }
    #ticks div {
        position: absolute;
        width: 2px;
        height: 12px;
        background: #333;
        left: 50%;
        top: 8px;
        transform-origin: bottom center;
    }
    #ticks span {
        position: absolute;
        font-size: 12px;
        font-weight: bold;
        color: #222;
        left: 50%;
        transform: translateX(-50%);
    }

    #needle {
        width: 4px;
        height: 95px;
        background: red;
        position: absolute;
        top: 25px;
        left: 49%;
        transform-origin: bottom center;
        transition: transform 1s ease-out;
        z-index: 5;
    }

    #barometer .center {
        width: 22px;
        height: 22px;
        background: #333;
        border-radius: 50%;
        position: absolute;
        top: 99px;
        left: 99px;
        z-index: 6;
    }

    .glass {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.5), rgba(255,255,255,0) 60%);
        pointer-events: none;
        z-index: 10;
    }
</style>
</head>

<body>

<h1>üìç M√©t√©o locale</h1>

<label for="citySelect"><strong>Choisir une ville :</strong></label>
<select id="citySelect">
    <option value="48.29764,-0.93143">Ern√©e</option>
    <option value="48.2250,-1.18148">Chatillon</option>
</select>

<div class="box">
    <h2>Barom√®tre</h2>
    <div id="barometer">
        <div id="zones"></div>
        <div id="ticks"></div>
        <div id="needle"></div>
        <div class="center"></div>
        <div class="glass"></div>
    </div>
    <div style="text-align:center; margin-top:8px;">
        Pression : <strong><span id="baroValue">‚Äî</span> hPa</strong>
    </div>
</div>

<div class="box">
    üå°Ô∏è Temp√©rature : <strong><span id="temp">‚Äî</span> ¬∞C</strong>
    <span id="apare">-</span>¬∞C<br>
    üíß Point de ros√©e : <strong><span id="dew">‚Äî</span> ¬∞C</strong><br>
    Pare brise : <strong><span id="par">‚Äî</span></strong><br><br>

    üìâ Pression : <strong><span id="pNow">‚Äî</span> hPa</strong>
    <span id="pOld">‚Äî</span> hPa<br>
    Tendance (4 h) : <strong><span id="pTrend">‚Äî</span></strong><br>

    üí® Vent : <strong><span id="wind">‚Äî</span> km/h</strong><br>
    Dir : <strong><span id="direText">‚Äî</span></strong><br>
    Rafales : <strong><span id="raf">‚Äî</span> km/h</strong><br>

    üåßÔ∏è Pluie (1 h) : <strong><span id="rain">‚Äî</span> mm</strong><br>
    Nuages : <strong><span id="cloud">‚Äî</span>%</strong><br>
    Visibilit√© : <strong><span id="visi">‚Äî</span> km</strong>
    <span id="icon"></span><br>
</div>

<div id="alertBox" class="alert">Chargement‚Ä¶</div>

<div class="box forecast" id="forecastText">‚Äî</div>

<!-- SECTION OPTION B : Pr√©visions 2h -->
<div class="box">
    <h2>Pr√©visions sur 2 heures</h2>
    <div id="forecast-2h"></div>
</div>

<div class="update">
    ‚è± Derni√®re mise √† jour : <span id="updateTime">‚Äî</span><br>
    <span>022026 coelod</span>
</div>



<script>
    let lat = 48.29764;
    let lon = -0.93143;

    const refreshTime = 10 * 10 * 1000; // 10 min

    function interp(v1, v2, ratio) {
        return v1 + (v2 - v1) * ratio;
    }

    function getWeatherIcon(rain, cloud, visi) {
        if (rain > 1) return "üåßÔ∏è";
        if (rain > 0.1) return "üå¶Ô∏è";
        if (cloud > 80) return "‚òÅÔ∏è";
        if (cloud > 40) return "‚õÖ";
        if (visi < 2) return "üå´Ô∏è";
        return "‚òÄÔ∏è";
    }



    function loadWeather() {

        const url =
        "https://api.open-meteo.com/v1/forecast" +
        "?latitude=" + lat +
        "&longitude=" + lon +
        "&hourly=temperature_2m,dew_point_2m,rain,pressure_msl,precipitation,visibility,wind_speed_10m,wind_direction_10m,wind_gusts_10m,apparent_temperature,cloud_cover" +
        "&timezone=Europe%2FParis" +
        "&models=best_match" +
		"&minutely_15=apparent_temperature,weather_code"+
		"&past_days=1"

        fetch(url)
        .then(r => r.json())
        .then(data => {
    const u = data.minutely_15.time.length ;
           const now = new Date();
    const hourStr = now.toISOString().slice(0, 13);
    const i = data.hourly.time.findIndex(t => t.startsWith(hourStr));
    if (i === -1 || i + 1 >= data.hourly.time.length) return;

    const ratio = now.getMinutes() / 60;
	

    if (i === -1) {
        ("Heure actuelle non trouv√©e dans les donn√©es");
        return;
    }



    const temp = interp(
        data.hourly.temperature_2m[i],
        data.hourly.temperature_2m[i+1],
        ratio
    );

    const dew = interp(
        data.hourly.dew_point_2m[i],
        data.hourly.dew_point_2m[i+1],
        ratio
    );

    const pNow = data.hourly.pressure_msl[i];

    const pOld = i >= 6 ? data.hourly.pressure_msl[i-6] : pNow;
    const diff = pNow - pOld;

    const rain = data.hourly.rain[i+1];
    const windX2 = interp(
        data.hourly.wind_speed_10m[i],
        data.hourly.wind_speed_10m[i+1],
        ratio
    );
    const apare = data.hourly.temperature_2m[i];
    const cloud = data.hourly.cloud_cover[i];
    const visi = data.hourly.visibility[i] / 1000;
    const dir = data.hourly.wind_direction_10m[i];
    const raf = data.hourly.wind_gusts_10m[i];
    const gel = temp - dew;
	const code = data.minutely_15.weather_code[u-1];

         

          /* Cr√©ation des graduations */
    function createTicks() {
        const ticks = document.getElementById("ticks");
        const values = [940,960, 980, 1000, 1020, 1040];

        values.forEach((val, index) => {
            const angle = -180 + (index * (180 / (values.length - 1)));

            const tick = document.createElement("div");
            tick.style.transform = `rotate(${angle}deg)`;

            const label = document.createElement("span");
            label.textContent = val;
            label.style.top = "25px";
            label.style.transform = `translateX(-50%) rotate(${angle}1deg)`;
            label.style.left = `${110 + Math.cos((angle * Math.PI)/180) * 80}px`;
            label.style.top = `${110 + Math.sin((angle * Math.PI)/180) * 80}px`;

            ticks.appendChild(tick);
            ticks.appendChild(label);
        });
    }

    createTicks();

    // Mise √† jour du barom√®tre
    document.getElementById("baroValue").textContent = pNow.toFixed(1);

    // Pression min/max pour l'√©chelle
    const minP = 940;
    const maxP = 1040;

    // Conversion pression ‚Üí angle (de -90¬∞ √† +90¬∞)
    let ratioP = (pNow - minP) / (maxP - minP);
    ratioP = Math.min(1, Math.max(0, ratioP)); // clamp

    const angle = -90 + ratioP * 180;

    document.getElementById("needle").style.transform =
        "rotate(" + angle.toFixed(1) + "deg)";

        document.getElementById("citySelect").addEventListener("change", function () {
        const [newLat, newLon] = this.value.split(",");
        lat = parseFloat(newLat);
        lon = parseFloat(newLon);
        loadWeather(); // recharge la m√©t√©o imm√©diatement
    });
function displayNext2HoursForecast(data) {
    const container = document.getElementById("forecast-2h");
    container.innerHTML = ""; // reset

    // 8 quarts d'heure = 2 heures
    for (let i = 0; i < 8; i++) {
        const code = data.minutely_15.weather_code[i];
        const temp = data.minutely_15.temperature_2m[i];
        const time = data.minutely_15.time[i].slice(11, 16); // HH:MM

        // Ic√¥ne Open-Meteo
        const iconPath = `icons/weather/${code}.png`;

        container.innerHTML += `
            <div class="quarter">
                <img src="${iconPath}" alt="code ${code}" class="wicon">
                <div>${time}</div>
                <div>${temp}¬∞C</div>
            </div>
        `;
    }
}

 displayNext2HoursForecast(data);
            const icon = getWeatherIcon(rain, cloud, visi);

            
            document.getElementById("icon").textContent = icon;

			
            document.getElementById("temp").textContent = temp.toFixed(1);
            document.getElementById("dew").textContent = dew.toFixed(1);
            document.getElementById("pNow").textContent = pNow.toFixed(1);
            document.getElementById("pTrend").textContent =
                diff > 1 ? "Hausse ‚¨ÜÔ∏è" : diff < -1 ? "Baisse ‚¨áÔ∏è" : "Stable ‚ûñ";
            document.getElementById("wind").textContent = windX2.toFixed(0);
            document.getElementById("rain").textContent = rain.toFixed(1);
            document.getElementById("cloud").textContent = cloud.toFixed(0);
            document.getElementById("par").textContent =
               gel > 0 ? " Clair" : temp < 0  && gel < 0 ? " Gel√©" : " Bu√©e";
            document.getElementById("visi").textContent = visi.toFixed(0);
            document.getElementById("pOld").textContent = pOld.toFixed(1);
            document.getElementById("raf").textContent = raf.toFixed(0);
            document.getElementById("apare").textContent = apare.toFixed(1);
            /*document.getElementById("code1").textContent = code1.toFixed(1);*/
            /*document.getElementById("code2").textContent = code2.toFixed(1);*/
            let dire;
            if (dir > 10 && dir < 80 ) {
                dire = "nord-est";
            } else if (dir > 79 && dir < 100){
                dire = "est";
            } else if (dir > 99 && dir < 170){
                dire = "sud-est";
            } else if (dir > 169 && dir <190){
                dire = "sud";
            } else if (dir > 189 && dir <260){
                dire = "sud-ouest";
            } else if (dir > 259 && dir <280){
                dire = "ouest";
            } else if (dir > 279 && dir <350){
                dire = "nord-ouest";
            } else {
				dire = "nord";
			}
            document.getElementById("direText").textContent = dire;
			let previ;
			if (code === 0 ) {
			previ = "ciel d√©gag√©";
			} else if (code === 1 ) {
			previ = "principalement clair";
			} else if (code === 2 ) {
			previ = "partiellement nuageux";
			} else if (code === 3 ) {
			previ = "couvert";
			} else if (code === 45 || code === 48 ) {
			previ = "brouillard";
			} else if (code === 51 ) {
			previ = "l√©g√®re bruine";
			} else if (code === 53 || code === 55 || code === 56 || code === 57 ) {
			previ = "bruine";
			} else if (code === 61 ) {
			previ = "l√©g√®re Pluie";
			} else if (code === 63 ) {
			previ = "pluie";
			} else if (code === 65 ) {
			previ = "pluie intense";
			} else if (code === 66 || code === 67 ) {
			previ = "pluie vergla√ßante";
			} else if (code === 71 || code === 73 || code === 75 ) {
			previ = "neige";
			} else if (code === 80 ) {
			previ = "l√©g√®re averses";
			} else if (code === 81 ) {
			previ = "averses";
			} else if (code === 82 ) {
			previ = "averses violentes";
			} else if (code === 95 ) {
			previ = "orages";
			} else if (code === 96 ) {
			previ = "orages et gr√®le";
			} else if (code === 99 ) {
			previ = "orages et gr√®le violent";
			} else {
			previ = code;
			}

			
            /* Pr√©vision texte */
            let forecast;
            if (diff < -1 && rain > 0) {
                forecast = "Pluie et pression en baisse : temps perturb√©. ";
            } else if (diff < -1 && windX2 > 40) {
                forecast = "Vent soutenu et pression en baisse : m√©t√©o agit√©e. ";
            } else if (diff > 1 && rain === 0) {
                forecast = "Pression en hausse : am√©lioration progressive. ";
            } else {
                forecast = "Temps variable sans √©volution marqu√©e. ";
            }
            document.getElementById("forecastText").textContent =
                "üìù Pr√©vision : " + forecast +  previ ;

            /* Alerte couleur */
            let alertText, alertClass;
            if ((diff < -1 && rain > 0) || windX2 > 50) {
                alertText = "üî¥ Alerte rouge : conditions perturb√©es.";
                alertClass = "red";
            } else if (diff < -1 || windX2 > 30) {
                alertText = "üü† Alerte orange : d√©gradation possible.";
                alertClass = "orange";
            } else {
                alertText = "üü¢ Alerte verte : m√©t√©o stable.";
                alertClass = "green";
            }

            const alertBox = document.getElementById("alertBox");
            alertBox.textContent = alertText;
            alertBox.className = "alert " + alertClass;

            /* Heure mise √† jour */
            document.getElementById("updateTime").textContent =
                new Date().toLocaleTimeString("fr-FR");

        })
        .catch(() => {
            const alertBox = document.getElementById("alertBox");
            alertBox.textContent = "Erreur de chargement m√©t√©o.";
            alertBox.className = "alert red";
        });
    }

    loadWeather();
    setInterval(loadWeather, refreshTime);
</script>



</body>
</html>




