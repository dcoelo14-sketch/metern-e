<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Météo locale – Ernée</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            color: #222;
        }

        header {
            background: #1976d2;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
        }

        .container {
            padding: 15px;
        }

        .current-weather {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-weather h2 {
            margin: 0;
            font-size: 26px;
        }

        .temp {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .forecast-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .forecast-grid {
            display: flex;
            overflow-x: auto;
            gap: 10px;
        }

        .forecast-item {
            min-width: 80px;
            background: #e9e9e9;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .forecast-item img {
            width: 50px;
            height: 50px;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #555;
        }
    </style>
</head>

<body>

<header>
    Météo locale – Ernée
</header>

<div class="container">

    <section class="current-weather">
        <h2>Météo actuelle</h2>
        <div id="current-temp" class="temp">--°C</div>
        <div id="current-desc">Chargement...</div>
        <img id="current-icon" src="" alt="" style="width:80px;height:80px;margin-top:10px;">
    </section>

    <section class="forecast-section">
        <h3>Prévisions prochaines heures</h3>
        <div id="forecast-hours" class="forecast-grid"></div>
    </section>

    <section class="forecast-section">
        <h3>Prévisions demain</h3>
        <div id="forecast-tomorrow" class="forecast-grid"></div>
    </section>

</div>
<script>
/* ------------------------------
   CONFIGURATION
--------------------------------*/
const API_URL = "https://api.open-meteo.com/v1/forecast";

/* ------------------------------
   UTILITAIRES
--------------------------------*/
function weatherDescription(code) {
    const map = {
        0: "Ciel clair",
        1: "Principalement clair",
        2: "Partiellement nuageux",
        3: "Couvert",
        45: "Brouillard",
        48: "Brouillard givrant",
        51: "Bruine légère",
        53: "Bruine modérée",
        55: "Bruine dense",
        61: "Pluie faible",
        63: "Pluie modérée",
        65: "Pluie forte",
        71: "Neige faible",
        73: "Neige modérée",
        75: "Neige forte",
        80: "Averses faibles",
        81: "Averses modérées",
        82: "Averses fortes",
        95: "Orage",
        96: "Orage avec grêle",
        99: "Orage violent"
    };
    return map[code] || "—";
}

function iconPath(code) {
    return `icons/weather/${code}.png`;
}

/* ------------------------------
   CHARGEMENT DES DONNÉES
--------------------------------*/
async function loadWeather(lat, lon) {
    const url = `${API_URL}?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,pressure_msl,wind_speed_10m,wind_direction_10m,dew_point_2m,visibility,cloud_cover&hourly=temperature_2m,weather_code,precipitation,wind_speed_10m,wind_gusts_10m,pressure_msl&timezone=auto`;

    const response = await fetch(url);
    const data = await response.json();

    updateCurrent(data);
    updateForecastHours(data);
    updateForecastTomorrow(data);
    updateBarometer(data);
}

/* ------------------------------
   METEO ACTUELLE
--------------------------------*/
function updateCurrent(data) {
    const c = data.current;

    document.getElementById("temp").textContent = Math.round(c.temperature_2m);
    document.getElementById("dew").textContent = Math.round(c.dew_point_2m);
    document.getElementById("pNow").textContent = Math.round(c.pressure_msl);
    document.getElementById("wind").textContent = Math.round(c.wind_speed_10m);
    document.getElementById("raf").textContent = Math.round(c.wind_gusts_10m || 0);
    document.getElementById("cloud").textContent = c.cloud_cover;
    document.getElementById("visi").textContent = (c.visibility / 1000).toFixed(1);

    document.getElementById("icon").innerHTML =
        `<img src="${iconPath(c.weather_code)}" width="60">`;

    document.getElementById("direText").textContent =
        directionText(c.wind_direction_10m);

    document.getElementById("updateTime").textContent =
        new Date().toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
}

function directionText(deg) {
    const dirs = ["N", "NE", "E", "SE", "S", "SO", "O", "NO"];
    return dirs[Math.round(deg / 45) % 8];
}

/* ------------------------------
   PREVISIONS PROCHAINES HEURES
--------------------------------*/
function updateForecastHours(data) {
    const hourly = data.hourly;
    const container = document.getElementById("forecast-hours");
    container.innerHTML = "";

    for (let i = 0; i < 6; i++) {
        const time = hourly.time[i].slice(11, 16);
        const temp = Math.round(hourly.temperature_2m[i]);
        const code = hourly.weather_code[i];

        container.innerHTML += `
            <div class="forecast-item">
                <div>${time}</div>
                <img src="${iconPath(code)}">
                <div>${temp}°C</div>
            </div>
        `;
    }
}

/* ------------------------------
   PREVISIONS DEMAIN
--------------------------------*/
function updateForecastTomorrow(data) {
    const hourly = data.hourly;
    const container = document.getElementById("forecast-tomorrow");
    container.innerHTML = "";

    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const targetDay = tomorrow.toISOString().slice(0, 10);

    for (let i = 0; i < hourly.time.length; i++) {
        if (hourly.time[i].startsWith(targetDay)) {
            const hour = hourly.time[i].slice(11, 16);
            const temp = Math.round(hourly.temperature_2m[i]);
            const code = hourly.weather_code[i];

            container.innerHTML += `
                <div class="forecast-item">
                    <div>${hour}</div>
                    <img src="${iconPath(code)}">
                    <div>${temp}°C</div>
                </div>
            `;
        }
    }
}

/* ------------------------------
   BAROMETRE
--------------------------------*/
function updateBarometer(data) {
    const p = data.current.pressure_msl;
    document.getElementById("baroValue").textContent = Math.round(p);

    const needle = document.getElementById("needle");

    // 960 hPa → -60° ; 1040 hPa → +60°
    const angle = ((p - 960) / 80) * 120 - 60;
    needle.style.transform = `rotate(${angle}deg)`;
}

/* ------------------------------
   CHANGEMENT DE VILLE
--------------------------------*/
document.getElementById("citySelect").addEventListener("change", function () {
    const [lat, lon] = this.value.split(",");
    loadWeather(lat, lon);
});

/* ------------------------------
   INITIALISATION
--------------------------------*/
window.onload = () => {
    const [lat, lon] = document.getElementById("citySelect").value.split(",");
    loadWeather(lat, lon);
};
</script>

</body>
</html>

